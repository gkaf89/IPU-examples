# Copyright (c) 2022 Graphcore Ltd. All rights reserved.

import numpy as np
import popxl_addons as addons
import torch
from rudalle.vae import get_vae

import popxl
from config import InferenceConfig
from modeling.image_decoder import VQGanGumbelVAE
from utils import repeat


def test_VQGanGumbelVAE():
    test_config = InferenceConfig()
    torch.manual_seed(42)
    module = get_vae()
    micro_bs = test_config.micro_batch_size

    # Torch forward
    quant = np.array([6869, 3030, 7091, 8013, 7249, 7091, 7091, 7808, 7119, 3030, 3030, 1652,
                      7119, 2094, 1813, 1652, 6194, 3030, 7091, 319,  7119, 778,  3030, 6179,
                      3030, 1476, 3030, 3030, 319,  3030, 1476, 4068, 1652, 5561, 7249, 7091,
                      7808, 662,  7249, 7249, 3030, 1652, 319,  319,  1911, 778,  2448, 7528,
                      4559, 6869, 7808, 3030, 7091, 7249, 7249, 7091, 7808, 7249, 144,  7249,
                      7091, 7091, 7249, 4131, 7808, 5561, 7808, 7091, 778, 5561,  578,  7808,
                      144,  144,  1652, 1476, 1813, 6291, 5413, 851,  4494, 6326, 144,  4559,
                      7249, 3030, 8140, 7091, 7091, 5561, 2646, 7808, 7091, 7091, 7808, 4068,
                      7119, 7091, 7035, 7035, 7091, 7091, 144,  3030, 3526, 778,  1911, 7119,
                      7101, 7043, 3161, 4524, 2287, 1476, 2686, 2557, 144,  7119, 7249, 3030,
                      630,  630,  5561, 3459, 7091, 7091, 5561, 578,  7119, 8140, 8140, 1911,
                      4377, 1569, 4072, 1476, 7119, 6633, 4423, 7182, 4428, 3504, 2480, 2115,
                      5647, 4602, 2089, 6045, 144,  5507, 4043, 1911, 8140, 8140, 1544, 7674,
                      7091, 7091, 1911, 578,  4131, 319,  7119, 144,  4559, 2226, 5647, 2644,
                      3084, 7178, 6936, 7195, 5688, 6167, 7132, 7276, 5586, 2642, 5267, 6869,
                      2488, 4143, 986,  4068, 1652, 3030, 8140, 7091, 7091, 144,  6869, 7091,
                      7119, 1652, 6869, 3466, 5557, 5732, 1714, 4440, 4440, 3884, 156,  4600,
                      7231, 6623, 4275, 6964, 3621, 1730, 6257, 2550, 3099, 7260, 4143, 4559,
                      3030, 144,  7808, 4559, 6226, 2043, 6869, 1652, 1813, 3619, 8140, 6194,
                      5973, 20,   4187, 4170, 4428, 4205, 3648, 4139, 5640, 646,  5848, 2979,
                      5671, 828,  3770, 1716, 6865, 1150, 4017, 1476, 7249, 144,  7119, 6869,
                      630,  7101, 4131, 1813, 3030, 144,  1476, 5862, 4693, 2880, 1714, 569,
                      7015, 4556, 876,  3381, 448,  7299, 513,  3842, 1011, 7915, 4924, 6252,
                      7372, 2866, 804,  6633, 2751, 1277, 2990, 6048, 2691, 2880, 6293, 144,
                      5848, 5610, 7182, 6394, 5875, 7107, 5873, 3177, 7411, 2465, 5421, 4309,
                      690,  879,  4340, 1310, 3181, 4649, 7709, 646,  3031, 3437, 3926, 6054,
                      3358, 3667, 3151, 2009, 1703, 1790, 7065, 3087, 3378, 4501, 569,  3835,
                      2708, 2291, 6862, 6610, 1425, 3678, 876,  3451, 7192, 296,  8017, 2109,
                      859,  3369, 7410, 2099, 3096, 3648, 3846, 1215, 7679, 8093, 6541, 1455,
                      2835, 7043, 3855, 6257, 3109, 5476, 8014, 4428, 7329, 4026, 3215, 713,
                      6111, 546,  7734, 3855, 2039, 6248, 6924, 5810, 5661, 4026, 6485, 5142,
                      5604, 2110, 5848, 211,  2907, 1552, 2278, 6702, 1877, 7627, 1113, 3803,
                      4522, 186,  172,  6464, 1828, 6289, 4918, 5781, 7086, 7501, 1525, 1053,
                      5133, 2103, 4492, 4990, 2384, 1460, 6584, 1297, 7834, 5185, 7416, 3329,
                      1543, 4814, 3326, 3935, 4682, 4593, 7881, 6032, 2465, 5741, 5299, 2698,
                      5588, 1425, 6214, 3195, 4007, 471,  1824, 4075, 2699, 5515, 3938, 3430,
                      692,  6819, 4337, 6902, 808,  5604, 4175, 2960, 925,  3765, 1920, 3115,
                      566,  3901, 5834, 198,  3438, 6252, 3437, 3904, 960,  5671, 2477, 189,
                      8017, 477,  3248, 1525, 4492, 6572, 2973, 1816, 3026, 4470, 181,  5409,
                      6849, 6753, 2815, 7086, 6306, 6274, 4600, 5203, 5557, 4805, 6702, 3230,
                      6263, 6180, 338,  2710, 4085, 4284, 1714, 7735, 7707, 1924, 5432, 8169,
                      1848, 2304, 5018, 5151, 7276, 2109, 3332, 1552, 4372, 3671, 6825, 7162,
                      4641, 7162, 729,  276,  3433, 6622, 1732, 4160, 1950, 1695, 5434, 6797,
                      1042, 5423, 6424, 4995, 6171, 528,  2609, 5185, 690,  7195, 6871, 4336,
                      21,   4981, 83,   6252, 7130, 179,  6687, 5027, 3204, 1822, 5904, 5124,
                      5702, 2130, 7776, 836,  7066, 3378, 5025, 6328, 583,  7494, 298,  4561,
                      6190, 3768, 5238, 5468, 8188, 499,  4685, 1356, 1873, 6222, 901,  6797,
                      7876, 4918, 1562, 33,   1652, 319,  4524, 1895, 6764, 5904, 6738, 4250,
                      34,   6797, 5025, 5996, 1186, 2133, 4607, 1124, 4076, 6003, 7689, 7913,
                      693,  5357, 31,   4722, 3093, 7266, 4585, 2960, 4471, 1571, 3920, 1975,
                      6619, 4072, 1089, 1042, 4440, 830,  6227, 1089, 1362, 360,  6561, 6947,
                      634,  4555, 4440, 7683, 1126, 6776, 1924, 2624, 7753, 5413, 1667, 7032,
                      7207, 4900, 5254, 4007, 1186, 5846, 6036, 1150, 4131, 3466, 7357, 6413,
                      7962, 6222, 5786, 1438, 7015, 1811, 7824, 4959, 7485, 5299, 2133, 925,
                      3204, 6973, 6245, 2048, 3750, 4390, 5635, 1372, 2689, 6969, 6705, 7257,
                      4001, 3187, 4566, 3472, 6819, 1464, 319,  2304, 7219, 603,  8081, 561,
                      7134, 2709, 7189, 6394, 2989, 3547, 3082, 4999, 6782, 3145, 898,  1924,
                      5185, 4112, 540,  3281, 5062, 7078, 3199, 6865, 6964, 2133, 2852, 7807,
                      4131, 6011, 958,  5603, 2157, 3684, 3125, 4859, 497,  4139, 2531, 1767,
                      1541, 7915, 3888, 2157, 2221, 6744, 5872, 4561, 1210, 8050, 3531, 4282,
                      6724, 2460, 4084, 808,  3094, 6263, 7327, 4187, 1652, 4594, 2054, 1652,
                      1242, 7162, 5407, 3024, 3412, 4674, 1119, 600,  7358, 3888, 3679, 7835,
                      851,  208,  5603, 2000, 3254, 5870, 771,  3065, 1201, 7434, 1172, 6969,
                      4492, 6121, 5047, 4996, 1476, 4597, 215,  304,  3127, 630,  1715, 7753,
                      2465, 1356, 7178, 1934, 62,   2550, 2111, 7397, 6424, 5038, 21,   923,
                      3957, 2913, 6979, 4996, 926,  1565, 53,   3991, 7166, 1417, 4215, 3903,
                      4068, 7738, 3889, 2776, 4311, 4597, 582,  958,  1876, 5781, 851,  2665,
                      7804, 5523, 1678, 1678, 7807, 2306, 1495, 1828, 6972, 6784, 3582, 5383,
                      634,  1284, 1236, 4075, 7178, 5167, 7335, 6650, 4143, 794,  5741, 5937,
                      2957, 2226, 6226, 1476, 4190, 1695, 2480, 3001, 5151, 1767, 2550, 5817,
                      1824, 4587, 5386, 4419, 2924, 7769, 267,  2047, 3627, 3312, 3904, 7192,
                      4034, 5205, 7093, 6606, 4131, 1911, 4398, 1495, 2451, 5741, 2320, 7948,
                      2999, 1235, 2281, 1992, 634,  4322, 3625, 7679, 831,  7807, 2468, 2754,
                      3708, 7180, 3024, 1913, 5631, 4372, 1165, 914,  2458, 1954, 5592, 7189,
                      5023, 4376, 5097, 5428, 2666, 4480, 1652, 7119, 2847, 155,  4630, 1021,
                      482,  1966, 2384, 1242, 4561, 5027, 3679, 1616, 5428, 1979, 1841, 7149,
                      4918, 6646, 5843, 5174, 6104, 2917, 6762, 2708, 7427, 1844, 7335, 5762,
                      2157, 1890, 7707, 6830, 7962, 2221, 5757, 3790, 3096, 7195, 1172, 8141,
                      4561, 3940, 7599, 5327, 1714, 447,  6209, 1301, 7733, 5934, 182,  2109,
                      7674, 405,  5904, 3096, 7962, 2447, 3569, 6452, 6762, 1425, 1792, 3569,
                      482,  5712, 4075, 5896, 7182, 4266, 1018, 7834, 970,  6935, 5700, 3640,
                      7835, 7427, 7950, 1844, 3569, 1276, 2400, 3466, 405,  2691, 7335, 6762,
                      5904, 4809, 1733, 371,  7050, 1391, 6472, 2700, 10,   7965, 4840, 2265,
                      482,  5918, 1881, 2012, 4942, 4266, 3177, 7202, 851,  7944, 5498, 296,
                      5468, 2724, 5324, 7969, 2684, 1939, 5550, 946,  4691, 5149, 1136, 2043,
                      958,  1652, 1652, 1652])
    quant = torch.from_numpy(quant).reshape(micro_bs, test_config.image_seq_len)
    output_torch = module.decode(quant)

    # popxl
    ir = popxl.Ir()
    n_ipus = test_config.ipus
    ir.replication_factor = n_ipus
    replica_grouping = ir.replica_grouping(stride=1, group_size=1)
    main = ir.main_graph

    quant = repeat(quant, n_ipus)
    with main:
        inputs_data, inputs_host_steam, inputs_tensors = zip(*[
            addons.host_load(quant[0], popxl.int32, name="images"),
        ])
        images, = inputs_tensors

        args, graph = VQGanGumbelVAE(
            test_config, n_ipus, replica_grouping, use_float16=False).create_graph(images)
        vars = args.init("dvae_decoder")

        token = graph.bind(vars)
        call_info = token.call_with_info(images)
        tokens, = call_info.outputs
        out = addons.host_store(tokens)

    session = popxl.Session(ir, "ipu_hw")
    weights = VQGanGumbelVAE.hf_mapping(test_config, vars, module)

    with session:
        session.write_variables_data(weights)
        inputs = dict(zip(inputs_host_steam, [quant]))
        outputs_popxl = session.run(inputs)

    np.testing.assert_almost_equal(output_torch.detach().numpy(), outputs_popxl[out][0], 5)


if __name__ == "__main__":
    test_VQGanGumbelVAE()
